@{
    ViewData["Title"] = "AESO Live Generation";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0"><i class="fas fa-bolt"></i> AESO Live Generation</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item active">AESO Live</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Status Row -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">
                                    <span class="badge badge-success" id="statusBadge">
                                        <i class="fas fa-circle"></i> LIVE
                                    </span>
                                </h5>
                            </div>
                            <div class="text-muted" id="lastUpdated">Loading...</div>
                            <div>
                                <button class="btn btn-primary" onclick="fetchData()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="row">
            <div class="col-lg-2 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3 id="albertaLoad">--</h3>
                        <p>Alberta Load (MW)</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3 id="totalGeneration">--</h3>
                        <p>Total Generation (MW)</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-industry"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3 style="color: white;" id="netToGrid">--</h3>
                        <p style="color: white;">Net to Grid (MW)</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-plug"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3 id="maxCapacity">--</h3>
                        <p>Max Capacity (MW)</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-6">
                <div class="small-box bg-secondary">
                    <div class="inner">
                        <h3 id="totalReserve">--</h3>
                        <p>Reserve (MW)</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-6">
                <div class="small-box bg-primary">
                    <div class="inner">
                        <h3 id="totalAssets">--</h3>
                        <p>Total Assets</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-building"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Row -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Generation by Fuel Type</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="fuelTypeChart" style="height: 400px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assets Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-table"></i> Asset Generation Details</h3>
                        <div class="card-tools">
                            <div class="input-group input-group-sm mr-2" style="width: 200px;">
                                <select class="form-control" id="fuelFilter" onchange="filterAssets()">
                                    <option value="">All Fuel Types</option>
                                </select>
                            </div>
                            <div class="input-group input-group-sm" style="width: 250px;">
                                <input type="text" id="assetSearch" class="form-control float-right" placeholder="Search asset..." onkeyup="filterAssets()">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-default">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0" style="height: 500px;">
                        <table class="table table-head-fixed text-nowrap table-hover">
                            <thead>
                                <tr>
                                    <th>Asset</th>
                                    <th>Fuel Type</th>
                                    <th>Sub Type</th>
                                    <th>Generation (MW)</th>
                                    <th>Capacity (MW)</th>
                                    <th>Utilization</th>
                                    <th>Reserve (MW)</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Loading asset data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        let allAssets = [];
        let fuelTypeChart = null;
        let autoRefreshInterval = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('AESO Live dashboard loaded, fetching data...');
            fetchData();
            startAutoRefresh();
        });

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(fetchData, 60000);
        }

        async function fetchData() {
            try {
                console.log('Fetching AESO data...');
                showLoading();
                updateStatus('warning', 'Updating...');
                
                const [v2Response, summaryResponse] = await Promise.all([
                    fetch('/api/AesoApi/v2/summary'),
                    fetch('/api/AesoApi/summary')
                ]);
                
                console.log('V2 Response:', v2Response.status);
                console.log('Summary Response:', summaryResponse.status);
                
                if (!v2Response.ok || !summaryResponse.ok) {
                    throw new Error('Failed to fetch data');
                }
                
                const v2Summary = await v2Response.json();
                const summary = await summaryResponse.json();
                
                updateSummary(v2Summary, summary);
                updateFuelTypeChart(v2Summary.fuelTypeDetails);
                
                const assetsResponse = await fetch('/api/AesoApi/current');
                const assetsData = await assetsResponse.json();
                
                allAssets = assetsData.assetList || [];
                updateAssetTable(allAssets);
                updateFuelTypeFilter();
                
                document.getElementById('lastUpdated').textContent = 
                    'Last Updated: ' + (v2Summary.lastUpdatedDatetimeMpt || 'N/A');
                
                updateStatus('success', 'LIVE');
                showToast('Data refreshed successfully', 'success');
                
            } catch (error) {
                console.error('Error fetching data:', error);
                updateStatus('danger', 'Offline');
                showToast('Failed to fetch data: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function updateStatus(type, text) {
            const badge = document.getElementById('statusBadge');
            badge.className = `badge badge-${type}`;
            badge.innerHTML = `<i class="fas fa-circle"></i> ${text}`;
        }

        function updateSummary(v2Summary, v1Summary) {
            animateValue('albertaLoad', v2Summary.albertaInternalLoad);
            animateValue('totalGeneration', v2Summary.totalNetGeneration);
            animateValue('netToGrid', v2Summary.netToGridGeneration);
            animateValue('maxCapacity', v2Summary.totalMaxGeneration);
            animateValue('totalReserve', v2Summary.dispatchedContingencyReserve);
            animateValue('totalAssets', v1Summary.totalAssets);
        }

        function animateValue(id, endValue) {
            const element = document.getElementById(id);
            const startValue = parseInt(element.textContent.replace(/,/g, '')) || 0;
            const duration = 1000;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(startValue + (endValue - startValue) * progress);
                element.textContent = current.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        function updateFuelTypeChart(fuelTypes) {
            const ctx = document.getElementById('fuelTypeChart');
            
            if (fuelTypeChart) {
                fuelTypeChart.destroy();
            }

            const colors = {
                'GAS': '#ffc107',
                'COGENERATION': '#ffc107',
                'COMBINED CYCLE': '#ff9800',
                'SIMPLE CYCLE': '#ffeb3b',
                'GAS FIRED STEAM': '#fdd835',
                'HYDRO': '#2196f3',
                'WIND': '#4caf50',
                'COAL': '#9e9e9e',
                'SOLAR': '#ffeb3b',
                'ENERGY STORAGE': '#9c27b0',
                'OTHER': '#607d8b'
            };

            const sorted = [...fuelTypes].sort((a, b) => b.netGeneration - a.netGeneration);

            fuelTypeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(f => f.fuelType),
                    datasets: [{
                        label: 'Current Generation (MW)',
                        data: sorted.map(f => f.netGeneration),
                        backgroundColor: sorted.map(f => colors[f.fuelType] || colors['OTHER']),
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const fuel = sorted[context.dataIndex];
                                    return [
                                        `Generation: ${fuel.netGeneration.toLocaleString()} MW`,
                                        `Max: ${fuel.maxGeneration.toLocaleString()} MW`,
                                        `Reserve: ${fuel.dispatchedContingencyReserve.toLocaleString()} MW`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value.toLocaleString() + ' MW'
                            }
                        }
                    }
                }
            });
        }

        function updateAssetTable(assets) {
            const tbody = document.getElementById('tableBody');
            
            if (!assets || assets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No assets found</td></tr>';
                return;
            }

            let html = '';
            assets.forEach(asset => {
                const utilization = asset.maximumCapability > 0 
                    ? (asset.netGeneration / asset.maximumCapability * 100).toFixed(1)
                    : 0;
                
                const fuelClass = 'fuel-' + asset.fuelType.replace(/\s+/g, '-');
                const utilizationColor = utilization > 80 ? 'success' : utilization > 50 ? 'warning' : 'secondary';
                
                html += `
                    <tr>
                        <td><strong>${asset.asset}</strong></td>
                        <td><span class="badge badge-info">${asset.fuelType}</span></td>
                        <td>${asset.subFuelType || '-'}</td>
                        <td><strong>${asset.netGeneration.toLocaleString()}</strong></td>
                        <td>${asset.maximumCapability.toLocaleString()}</td>
                        <td>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-${utilizationColor}" style="width: ${Math.min(utilization, 100)}%"></div>
                            </div>
                            <small>${utilization}%</small>
                        </td>
                        <td>${asset.dispatchedContingencyReserve.toLocaleString()}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function updateFuelTypeFilter() {
            const filter = document.getElementById('fuelFilter');
            const currentValue = filter.value;
            
            filter.innerHTML = '<option value="">All Fuel Types</option>';
            
            const uniqueFuelTypes = [...new Set(allAssets.map(a => a.fuelType))].sort();
            uniqueFuelTypes.forEach(fuelType => {
                const count = allAssets.filter(a => a.fuelType === fuelType).length;
                filter.innerHTML += `<option value="${fuelType}">${fuelType} (${count})</option>`;
            });
            
            filter.value = currentValue;
        }

        function filterAssets() {
            const fuelFilter = document.getElementById('fuelFilter').value.toLowerCase();
            const searchTerm = document.getElementById('assetSearch').value.toLowerCase();
            
            const filtered = allAssets.filter(asset => {
                const matchesFuel = !fuelFilter || asset.fuelType.toLowerCase() === fuelFilter;
                const matchesSearch = !searchTerm || asset.asset.toLowerCase().includes(searchTerm);
                return matchesFuel && matchesSearch;
            });
            
            updateAssetTable(filtered);
        }
    </script>
}
