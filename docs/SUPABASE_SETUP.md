# Supabase Setup Guide

This guide walks you through setting up Supabase for the PlantSight project.

## Your Supabase Configuration

**Project URL**: `https://inrdnmdguyyfgwbelrhb.supabase.co`

**Connection Details**:
- Host: `aws-0-us-east-1.pooler.supabase.com`
- Port: `6543` (Pooler) or `5432` (Direct)
- Database: `postgres`
- Username: `postgres.inrdnmdguyyfgwbelrhb`
- Password: `Hamza@123`

## Step 1: Access Supabase Dashboard

1. Go to https://supabase.com
2. Sign in with your account
3. Select your project: `inrdnmdguyyfgwbelrhb`

## Step 2: Create Database Schema

### Option A: Using SQL Editor (Recommended)

1. In Supabase dashboard, click **SQL Editor** in left sidebar
2. Click **New Query** button
3. Copy the entire contents of `docs/supabase-schema.sql` from this project
4. Paste into the SQL Editor
5. Click **Run** button (or press `Ctrl+Enter` / `Cmd+Enter`)

You should see success messages:
```
Success. No rows returned
```

### Option B: Using psql Command Line

If you have PostgreSQL client installed:

```bash
psql "postgresql://postgres.inrdnmdguyyfgwbelrhb:Hamza@123@aws-0-us-east-1.pooler.supabase.com:6543/postgres" -f docs/supabase-schema.sql
```

## Step 3: Verify Schema Creation

### Check Tables

1. In Supabase dashboard, click **Table Editor**
2. You should see these tables:
   - `tag` (4 rows - sample data)
   - `tag_sample` (empty initially)
   - `alarm_rule` (2 rows - sample alarms)
   - `alarm_event` (empty initially)
   - `audit_event` (empty initially)

### Check Sample Data

Click on `tag` table. You should see:

| name | eu | span_low | span_high | datatype |
|------|-----|----------|-----------|----------|
| UnitA.Temp | degC | 0 | 200 | float |
| UnitA.Pressure | bar | 0 | 50 | float |
| UnitA.Flow | m3/h | 0 | 500 | float |
| UnitB.Level | % | 0 | 100 | float |

## Step 4: Configure Application

The application is already configured with your Supabase credentials in `src/Dashboard.Web/appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=aws-0-us-east-1.pooler.supabase.com;Port=6543;Database=postgres;Username=postgres.inrdnmdguyyfgwbelrhb;Password=Hamza@123"
  },
  "Supabase": {
    "Url": "https://inrdnmdguyyfgwbelrhb.supabase.co",
    "AnonKey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "ServiceRoleKey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

✅ **No changes needed** - configuration is complete!

## Step 5: Test Connection

### Option A: From Application

```bash
dotnet run --project src/Dashboard.Web
```

Check the console output. You should NOT see any database connection errors.

### Option B: Using Supabase API

Test the REST API (auto-generated by Supabase):

```bash
curl https://inrdnmdguyyfgwbelrhb.supabase.co/rest/v1/tag \
  -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlucmRubWRndXl5Zmd3YmVscmhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTgyNDAsImV4cCI6MjA3ODM5NDI0MH0.ikAZhNIW0U6iE_P_S9-X7svrCyjdcLqam08YbhtNPrY" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlucmRubWRndXl5Zmd3YmVscmhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTgyNDAsImV4cCI6MjA3ODM5NDI0MH0.ikAZhNIW0U6iE_P_S9-X7svrCyjdcLqam08YbhtNPrY"
```

You should get JSON response with tag data.

## Database Schema Overview

### Tables

#### `tag`
Stores process variable definitions (sensors, actuators, etc.)

**Key Columns**:
- `tag_id`: Unique identifier (UUID)
- `name`: Tag name (e.g., "UnitA.Temp")
- `eu`: Engineering units (e.g., "degC", "bar")
- `span_low`, `span_high`: Value range
- `read_register`, `write_register`: Modbus register addresses

#### `tag_sample`
Time-series historian data

**Key Columns**:
- `ts`: Timestamp (primary key part)
- `tag_id`: Reference to tag (primary key part)
- `value`: Process value
- `quality`: Data quality (192 = Good)

#### `alarm_rule`
Alarm threshold definitions

**Key Columns**:
- `tag_id`: Tag to monitor
- `type`: Alarm type (HH, H, L, LL, ROC)
- `threshold`: Alarm setpoint
- `severity`: 1-4 (Info, Low, High, Critical)
- `hyst_pct`: Hysteresis percentage
- `delay_on_ms`, `delay_off_ms`: Debounce timers

#### `alarm_event`
Alarm lifecycle events

**Key Columns**:
- `alarm_rule_id`: Which rule triggered
- `ts_start`: When alarm activated
- `ts_end`: When alarm cleared
- `state`: Active, RTN (Return to Normal), Acked
- `ack_by`: Who acknowledged
- `ack_ts`: When acknowledged

#### `audit_event`
User action audit trail

**Key Columns**:
- `user_name`: Who performed action
- `action`: What was done
- `details`: JSON details
- `ts`: When it happened

### Indexes

Performance indexes are created automatically:
- `idx_tag_sample_tag_ts`: Fast time-series queries
- `idx_alarm_event_tag_ts`: Fast alarm history
- `idx_audit_ts`: Fast audit log queries
- `idx_alarm_rule_tag`: Fast alarm rule lookups
- `idx_tag_name`: Fast tag name lookups

## Supabase Features

### Auto-Generated REST API

Supabase automatically creates REST API for all tables:

**Base URL**: `https://inrdnmdguyyfgwbelrhb.supabase.co/rest/v1/`

**Examples**:
```bash
# Get all tags
GET /tag

# Get specific tag
GET /tag?name=eq.UnitA.Temp

# Get recent samples
GET /tag_sample?order=ts.desc&limit=100

# Get active alarms
GET /alarm_event?state=eq.Active
```

### Real-Time Subscriptions (Optional)

You can subscribe to database changes:

```javascript
const { createClient } = require('@supabase/supabase-js')

const supabase = createClient(
  'https://inrdnmdguyyfgwbelrhb.supabase.co',
  'your-anon-key'
)

// Subscribe to new tag samples
supabase
  .from('tag_sample')
  .on('INSERT', payload => {
    console.log('New sample:', payload.new)
  })
  .subscribe()
```

### Database Backups

Supabase automatically backs up your database daily.

**To download backup**:
1. Go to **Database** → **Backups**
2. Click **Download** on desired backup

### Connection Pooling

Your connection string uses **Pooler mode** (port 6543):
- Recommended for serverless/web applications
- Handles connection pooling automatically
- Better for applications with many short-lived connections

**Direct connection** (port 5432):
- Use for long-running applications
- Use for database tools (pgAdmin, etc.)
- No connection pooling

## Troubleshooting

### "Connection timeout"

**Cause**: Firewall or network issue

**Solution**:
1. Check your internet connection
2. Verify Supabase project is running (green status in dashboard)
3. Try direct connection (port 5432) instead of pooler (port 6543)

### "Password authentication failed"

**Cause**: Incorrect password or username

**Solution**:
1. Verify password is `Hamza@123` (case-sensitive)
2. Check username is `postgres.inrdnmdguyyfgwbelrhb`
3. Reset password in Supabase dashboard: **Settings** → **Database** → **Reset database password**

### "Table does not exist"

**Cause**: Schema not created

**Solution**:
1. Run `docs/supabase-schema.sql` in SQL Editor
2. Verify tables exist in Table Editor

### "Too many connections"

**Cause**: Connection pool exhausted

**Solution**:
1. Use Pooler connection (port 6543) - already configured
2. Ensure application properly disposes DbContext
3. Consider upgrading Supabase plan for more connections

### "SSL required"

**Cause**: Supabase requires SSL connections

**Solution**:
Add to connection string:
```
;SslMode=Require
```

Full connection string:
```
Host=aws-0-us-east-1.pooler.supabase.com;Port=6543;Database=postgres;Username=postgres.inrdnmdguyyfgwbelrhb;Password=Hamza@123;SslMode=Require
```

## Security Best Practices

### Development vs Production

✅ **Current setup is for DEVELOPMENT only**

For production:

1. **Never commit credentials to git**
   - Use environment variables
   - Use secrets manager (Azure Key Vault, AWS Secrets Manager)

2. **Use Row Level Security (RLS)**
   ```sql
   ALTER TABLE tag ENABLE ROW LEVEL SECURITY;
   
   CREATE POLICY "Allow authenticated users to read tags"
   ON tag FOR SELECT
   TO authenticated
   USING (true);
   ```

3. **Create dedicated database users**
   ```sql
   CREATE USER app_user WITH PASSWORD 'strong_password';
   GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO app_user;
   ```

4. **Rotate keys regularly**
   - Regenerate Anon Key monthly
   - Regenerate Service Role Key quarterly

5. **Enable audit logging**
   - Already implemented in `audit_event` table
   - Log all write operations

### Connection String Security

**❌ Don't**:
```json
// In appsettings.json (committed to git)
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=...;Password=production_password"
  }
}
```

**✅ Do**:
```bash
# Environment variable
export ConnectionStrings__DefaultConnection="Host=...;Password=production_password"
```

Or use User Secrets (development):
```bash
dotnet user-secrets set "ConnectionStrings:DefaultConnection" "Host=...;Password=dev_password"
```

## Next Steps

1. ✅ Schema created
2. ✅ Sample data loaded
3. ✅ Application configured
4. ▶️ Run application: `dotnet run --project src/Dashboard.Web`
5. ▶️ Test connection
6. ▶️ Start building features!

## Support

**Supabase Documentation**: https://supabase.com/docs

**PostgreSQL Documentation**: https://www.postgresql.org/docs/

**Project Issues**: Open issue in repository with:
- Error message
- Steps to reproduce
- Supabase dashboard screenshots (hide credentials!)



